databaseChangeLog:
  - changeSet:
      id: 0001-create-core-tables
      author: jikvict
      changes:
        # USERS
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_users
                    nullable: false
              - column:
                  name: username
                  type: VARCHAR(255)
                  constraints:
                    unique: true
              - column:
                  name: email
                  type: VARCHAR(255)
              - column:
                  name: ais_id
                  type: VARCHAR(255)

        # ROLES
        - createTable:
            tableName: roles
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_roles
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
                    unique: true

        # USER_ROLES (join table)
        - createTable:
            tableName: user_roles
            columns:
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: role_id
                  type: BIGINT
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: user_roles
            columnNames: user_id, role_id
            constraintName: pk_user_roles
        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_user_roles_user
        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: role_id
            referencedTableName: roles
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_user_roles_role

        # ASSIGNMENT_GROUPS
        - createTable:
            tableName: assignment_groups
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_assignment_groups
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false

        # USERS <-> ASSIGNMENT_GROUPS (join)
        - createTable:
            tableName: user_assignment_groups
            columns:
              - column:
                  name: assignment_group_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: user_assignment_groups
            columnNames: assignment_group_id, user_id
            constraintName: pk_user_assignment_groups
        - addForeignKeyConstraint:
            baseTableName: user_assignment_groups
            baseColumnNames: assignment_group_id
            referencedTableName: assignment_groups
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_uag_group
        - addForeignKeyConstraint:
            baseTableName: user_assignment_groups
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_uag_user

        # ASSIGNMENTS
        - createTable:
            tableName: assignments
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_assignments
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: task_id
                  type: INTEGER
                  constraints:
                    nullable: false
              - column:
                  name: max_points
                  type: INTEGER
                  constraints:
                    nullable: false
              - column:
                  name: start_date
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: end_date
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: time_out_seconds
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: memory_limit
                  type: BIGINT
              - column:
                  name: cpu_limit
                  type: BIGINT
              - column:
                  name: pids_limit
                  type: BIGINT
              - column:
                  name: maximum_attempts
                  type: INTEGER
                  defaultValueNumeric: 2
                  constraints:
                    nullable: false
              - column:
                  name: status_override
                  type: VARCHAR(16)
                  constraints:
                    nullable: false

        # ASSIGNMENT_GROUP_ASSIGNMENTS (join)
        - createTable:
            tableName: assignment_group_assignments
            columns:
              - column:
                  name: group_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: assignment_id
                  type: BIGINT
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: assignment_group_assignments
            columnNames: group_id, assignment_id
            constraintName: pk_assignment_group_assignments
        - addForeignKeyConstraint:
            baseTableName: assignment_group_assignments
            baseColumnNames: group_id
            referencedTableName: assignment_groups
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_aga_group
        - addForeignKeyConstraint:
            baseTableName: assignment_group_assignments
            baseColumnNames: assignment_id
            referencedTableName: assignments
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_aga_assignment

        # ASSIGNMENT_RESULT
        - createTable:
            tableName: assignment_result
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_assignment_result
                    nullable: false
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: assignment_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: time_stamp
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: points
                  type: INTEGER
                  constraints:
                    nullable: false
              - column:
                  name: execution_logs
                  type: jsonb
        - addForeignKeyConstraint:
            baseTableName: assignment_result
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_assignment_result_user
        - addForeignKeyConstraint:
            baseTableName: assignment_result
            baseColumnNames: assignment_id
            referencedTableName: assignments
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_assignment_result_assignment

        # REFRESH TOKENS
        - createTable:
            tableName: refresh_tokens
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_refresh_tokens
                    nullable: false
              - column:
                  name: token
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: expiry_date
                  type: TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: refresh_tokens
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_refresh_tokens_user

        # TASK STATUSES
        - createTable:
            tableName: task_statuses
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_task_statuses
                    nullable: false
              - column:
                  name: task_type
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: message
                  type: TEXT
              - column:
                  name: result_id
                  type: BIGINT
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: completed_at
                  type: TIMESTAMP
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: parameters
                  type: TEXT
        - addForeignKeyConstraint:
            baseTableName: task_statuses
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: SET NULL
            constraintName: fk_task_statuses_user
